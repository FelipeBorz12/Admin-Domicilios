<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Equipos | Usuarios Cocina</title>

    <link rel="stylesheet" href="/styles.css" />
    <script src="/tw-config.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>

  <body class="min-h-screen bg-slate-50 text-slate-900">
    <header class="sticky top-0 z-20 bg-white border-b border-slate-200">
      <div
        class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4"
      >
        <!-- Left: back + titles -->
        <div class="flex items-center gap-3 min-w-0">
          <!-- Back button -->
          <a
            href="/admin"
            class="h-10 w-10 shrink-0 rounded-full border border-slate-200 grid place-items-center hover:bg-slate-50 active:scale-[0.99] transition"
            aria-label="Volver al panel"
          >
            <!-- inline icon -->
            <svg
              width="18"
              height="18"
              viewBox="0 0 24 24"
              fill="none"
              aria-hidden="true"
            >
              <path
                d="M15 18l-6-6 6-6"
                stroke="currentColor"
                stroke-width="2.2"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
            </svg>
          </a>

          <div class="min-w-0">
            <div class="text-xs font-semibold text-slate-500 leading-tight">
              Editor
            </div>

            <div class="flex items-center gap-2 min-w-0">
              <h1
                class="truncate text-lg font-semibold text-slate-900 leading-tight"
              >
                Equipos (Usuarios Cocina)
              </h1>

              <!-- Badge like BORRADOR -->
              <span
                class="shrink-0 text-[11px] font-extrabold uppercase px-3 py-1 rounded-full bg-amber-100 text-amber-700"
              >
                Gestión
              </span>
            </div>
          </div>
        </div>

        <!-- Right: actions (same style as screenshot) -->
        <div class="flex items-center gap-2">
          <!-- Outline button (like “Cargar actual”) -->
          <button
            id="btnRefresh"
            type="button"
            class="px-4 py-2 rounded-full border border-slate-200 bg-white hover:bg-slate-50 text-sm font-semibold text-slate-800 transition"
          >
            Cargar actual
          </button>

          <!-- Blue primary button (like “Publicar”) -->
          <button
            id="btnOpenCreate"
            type="button"
            class="px-4 py-2 rounded-full bg-blue-600 hover:bg-blue-700 text-white text-sm font-extrabold transition"
          >
            + Crear usuario
          </button>
        </div>
      </div>
    </header>

    <main class="max-w-6xl mx-auto px-4 py-6">
      <section
        class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm"
      >
        <div class="flex flex-col md:flex-row md:items-end gap-3">
          <div class="flex-1">
            <label class="text-sm font-medium text-slate-700">Buscar</label>
            <input
              id="searchInput"
              type="text"
              placeholder="Busca por correo, administrador o local..."
              class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-300"
            />
          </div>

          <div class="w-full md:w-72">
            <label class="text-sm font-medium text-slate-700"
              >Filtrar por local</label
            >
            <select
              id="filterPV"
              class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300"
            >
              <option value="">Todos</option>
            </select>
          </div>

          <div class="w-full md:w-40">
            <label class="text-sm font-medium text-slate-700">Orden</label>
            <select
              id="sortSelect"
              class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300"
            >
              <option value="new">Más nuevos</option>
              <option value="old">Más antiguos</option>
              <option value="correo">Correo (A-Z)</option>
              <option value="pv">Local (A-Z)</option>
            </select>
          </div>
        </div>

        <div class="mt-4 flex items-center justify-between gap-3">
          <p id="statusText" class="text-sm text-slate-600">Cargando…</p>
          <p class="text-xs text-slate-500">
            * Un usuario de cocina está asociado a un único local
            (<code>PuntoVenta</code>).
          </p>
        </div>
      </section>

      <section
        class="mt-4 bg-white border border-slate-200 rounded-2xl shadow-sm overflow-hidden"
      >
        <div class="overflow-x-auto">
          <table class="min-w-full">
            <thead class="bg-slate-50 border-b border-slate-200">
              <tr class="text-left text-sm text-slate-600">
                <th class="px-4 py-3 font-semibold">ID</th>
                <th class="px-4 py-3 font-semibold">Administrador</th>
                <th class="px-4 py-3 font-semibold">Correo</th>
                <th class="px-4 py-3 font-semibold">Local (PuntoVenta)</th>
                <th class="px-4 py-3 font-semibold text-right">Acciones</th>
              </tr>
            </thead>
            <tbody id="tbody" class="divide-y divide-slate-200"></tbody>
          </table>
        </div>

        <div id="emptyState" class="hidden p-10 text-center">
          <p class="text-slate-700 font-medium">
            No hay usuarios que coincidan con el filtro.
          </p>
          <p class="text-slate-500 text-sm mt-1">
            Prueba a cambiar búsqueda/filtro u crea uno nuevo.
          </p>
        </div>
      </section>
    </main>

    <div id="backdrop" class="hidden fixed inset-0 bg-black/40 z-40"></div>

    <!-- Modal Crear/Editar -->
    <div
      id="modalForm"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
    >
      <div
        class="w-full max-w-lg bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden"
      >
        <div
          class="p-4 border-b border-slate-200 flex items-center justify-between"
        >
          <div>
            <h2 id="modalFormTitle" class="text-base font-semibold">
              Crear usuario
            </h2>
            <p class="text-sm text-slate-600">
              La contraseña se guarda hasheada con bcryptjs.
            </p>
          </div>
          <button
            class="px-3 py-1.5 rounded-xl border border-slate-300 hover:bg-slate-50"
            data-close="modalForm"
          >
            Cerrar
          </button>
        </div>

        <form id="userForm" class="p-4 space-y-3">
          <input type="hidden" id="formId" value="" />

          <div>
            <label class="text-sm font-medium text-slate-700"
              >Administrador</label
            >
            <input
              id="formAdmin"
              type="text"
              required
              class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-300"
            />
          </div>

          <div>
            <label class="text-sm font-medium text-slate-700">Correo</label>
            <input
              id="formCorreo"
              type="email"
              required
              class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-300"
            />
          </div>

          <!-- Local + buscador -->
          <div>
            <label class="text-sm font-medium text-slate-700"
              >Local (PuntoVenta)</label
            >

            <input
              id="pvSearch"
              type="text"
              placeholder="Escribe para buscar un local…"
              class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-300"
            />

            <select
              id="formPV"
              required
              class="mt-2 w-full px-3 py-2 rounded-xl border border-slate-300 bg-white focus:outline-none focus:ring-2 focus:ring-slate-300"
            ></select>

            <p class="text-xs text-slate-500 mt-1">
              No puede repetirse: es único por tabla.
            </p>
          </div>

          <!-- ✅ CREAR: Contraseña (auto / manual) -->
          <div id="createPasswordBlock" class="border-t border-slate-200 pt-3">
            <label class="text-sm font-medium text-slate-700"
              >Contraseña (solo al crear)</label
            >

            <div class="mt-2 flex flex-col gap-2">
              <label class="flex items-center gap-2 text-sm">
                <input
                  type="radio"
                  name="passModeCreate"
                  id="passModeAuto"
                  value="auto"
                  checked
                />
                <span><b>Generar automáticamente</b> (recomendado)</span>
              </label>

              <label class="flex items-center gap-2 text-sm">
                <input
                  type="radio"
                  name="passModeCreate"
                  id="passModeManual"
                  value="manual"
                />
                <span><b>Ingresar manualmente</b></span>
              </label>
            </div>

            <div id="manualPasswordFields" class="hidden mt-3 space-y-3">
              <div>
                <label class="text-sm font-medium text-slate-700"
                  >Nueva contraseña</label
                >
                <div class="mt-1 flex gap-2">
                  <input
                    id="formPassword"
                    type="password"
                    autocomplete="new-password"
                    class="flex-1 px-3 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-300"
                    placeholder="Mínimo 12 caracteres"
                  />
                  <button
                    id="btnTogglePass"
                    type="button"
                    class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50"
                    aria-label="Mostrar/Ocultar"
                  >
                    Ver
                  </button>
                </div>

                <div
                  class="mt-2 h-2 w-full rounded-full bg-slate-100 border border-slate-200 overflow-hidden"
                >
                  <div
                    id="passStrengthBar"
                    class="h-full w-0 bg-slate-900"
                  ></div>
                </div>

                <p id="passStrengthText" class="mt-1 text-xs text-slate-600">
                  Escribe una contraseña para ver su fortaleza.
                </p>
              </div>

              <div>
                <label class="text-sm font-medium text-slate-700"
                  >Confirmar contraseña</label
                >
                <input
                  id="formPassword2"
                  type="password"
                  autocomplete="new-password"
                  class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-300"
                  placeholder="Repite la contraseña"
                />
              </div>

              <div
                class="text-xs text-slate-600 bg-slate-50 border border-slate-200 rounded-xl p-3 leading-relaxed"
              >
                <p class="font-semibold text-slate-800">
                  Requisitos de seguridad
                </p>
                <ul class="list-disc pl-5 mt-2 space-y-1">
                  <li>
                    Mínimo <b>12</b> caracteres (máximo <b>72</b> por bcrypt).
                  </li>
                  <li>
                    Al menos: <b>1</b> mayúscula, <b>1</b> minúscula,
                    <b>1</b> número y <b>1</b> símbolo.
                  </li>
                  <li>Sin espacios.</li>
                  <li>
                    No debe contener el correo (ni partes obvias del mismo).
                  </li>
                  <li>
                    Evitar contraseñas comunes (ej: <code>123456</code>,
                    <code>password</code>, <code>qwerty</code>).
                  </li>
                </ul>
              </div>

              <div
                id="passError"
                class="hidden text-sm text-red-600 bg-red-50 border border-red-200 rounded-xl p-3"
              ></div>
            </div>

            <p id="autoPassHint" class="mt-2 text-xs text-slate-500">
              Si eliges “Generar automáticamente”, se mostrará una contraseña
              una sola vez para copiarla.
            </p>
          </div>

          <!-- ✅ EDITAR: Reset + Cambio manual -->
          <div
            id="editExtras"
            class="hidden border-t border-slate-200 pt-3 space-y-3"
          >
            <div class="flex items-center justify-between gap-2">
              <button
                id="btnResetPassInline"
                type="button"
                class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50"
              >
                Resetear contraseña
              </button>

              <span class="text-xs text-slate-500">
                (El reset genera una nueva aleatoria)
              </span>
            </div>

            <div class="border border-slate-200 rounded-xl p-3 bg-slate-50">
              <p class="text-sm font-semibold text-slate-800">
                Cambiar contraseña manualmente (opcional)
              </p>

              <label class="mt-2 flex items-center gap-2 text-sm">
                <input type="checkbox" id="editEnableManualPass" />
                <span>Quiero definir una nueva contraseña manual</span>
              </label>

              <div id="editManualPasswordFields" class="hidden mt-3 space-y-3">
                <div>
                  <label class="text-sm font-medium text-slate-700"
                    >Nueva contraseña</label
                  >
                  <div class="mt-1 flex gap-2">
                    <input
                      id="editPassword"
                      type="password"
                      autocomplete="new-password"
                      class="flex-1 px-3 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-300"
                      placeholder="Mínimo 12 caracteres"
                    />
                    <button
                      id="editBtnTogglePass"
                      type="button"
                      class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50"
                      aria-label="Mostrar/Ocultar"
                    >
                      Ver
                    </button>
                  </div>

                  <div
                    class="mt-2 h-2 w-full rounded-full bg-white border border-slate-200 overflow-hidden"
                  >
                    <div
                      id="editPassStrengthBar"
                      class="h-full w-0 bg-slate-900"
                    ></div>
                  </div>

                  <p
                    id="editPassStrengthText"
                    class="mt-1 text-xs text-slate-600"
                  >
                    Escribe una contraseña para ver su fortaleza.
                  </p>
                </div>

                <div>
                  <label class="text-sm font-medium text-slate-700"
                    >Confirmar contraseña</label
                  >
                  <input
                    id="editPassword2"
                    type="password"
                    autocomplete="new-password"
                    class="mt-1 w-full px-3 py-2 rounded-xl border border-slate-300 focus:outline-none focus:ring-2 focus:ring-slate-300"
                    placeholder="Repite la contraseña"
                  />
                </div>

                <div
                  id="editPassError"
                  class="hidden text-sm text-red-600 bg-red-50 border border-red-200 rounded-xl p-3"
                ></div>
              </div>
            </div>
          </div>

          <div
            id="formError"
            class="hidden text-sm text-red-600 bg-red-50 border border-red-200 rounded-xl p-3"
          ></div>

          <div class="pt-2 flex items-center justify-end gap-2">
            <button
              type="button"
              class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50"
              data-close="modalForm"
            >
              Cancelar
            </button>
            <button
              id="btnSubmit"
              type="submit"
              class="px-3 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800"
            >
              Guardar
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal Confirm delete -->
    <div
      id="modalConfirm"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
    >
      <div
        class="w-full max-w-md bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden"
      >
        <div
          class="p-4 border-b border-slate-200 flex items-center justify-between"
        >
          <h2 class="text-base font-semibold">Eliminar usuario</h2>
          <button
            class="px-3 py-1.5 rounded-xl border border-slate-300 hover:bg-slate-50"
            data-close="modalConfirm"
          >
            Cerrar
          </button>
        </div>

        <div class="p-4">
          <p class="text-slate-700">
            ¿Eliminar <span id="confirmCorreo" class="font-semibold"></span>?
          </p>
          <p class="text-sm text-slate-500 mt-1">No se puede deshacer.</p>

          <div
            id="confirmError"
            class="hidden mt-3 text-sm text-red-600 bg-red-50 border border-red-200 rounded-xl p-3"
          ></div>

          <div class="mt-4 flex items-center justify-end gap-2">
            <button
              type="button"
              class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50"
              data-close="modalConfirm"
            >
              Cancelar
            </button>
            <button
              id="btnConfirmDelete"
              class="px-3 py-2 rounded-xl bg-red-600 text-white hover:bg-red-700"
            >
              Eliminar
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal password -->
    <div
      id="modalPassword"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
    >
      <div
        class="w-full max-w-md bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden"
      >
        <div
          class="p-4 border-b border-slate-200 flex items-center justify-between"
        >
          <h2 class="text-base font-semibold">Contraseña generada</h2>
          <button
            class="px-3 py-1.5 rounded-xl border border-slate-300 hover:bg-slate-50"
            data-close="modalPassword"
          >
            Cerrar
          </button>
        </div>

        <div class="p-4">
          <p class="text-sm text-slate-600">
            Guárdala ahora. Por seguridad, no se vuelve a mostrar.
          </p>
          <div
            class="mt-3 p-3 rounded-xl bg-slate-900 text-white font-mono text-sm break-all"
            id="generatedPassword"
          ></div>

          <div class="mt-4 flex items-center justify-end gap-2">
            <button
              id="btnCopyPass"
              class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50"
            >
              Copiar
            </button>
            <button
              class="px-3 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800"
              data-close="modalPassword"
            >
              Listo
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden" aria-hidden="true">
      <div class="loading-backdrop"></div>
      <div class="loading-card">
        <span class="spinner"></span>
        <div class="loading-text">Procesando…</div>
      </div>
    </div>

    <!-- Modal: Confirmar reset password -->
    <div
      id="modalReset"
      class="hidden fixed inset-0 z-50 flex items-center justify-center p-4"
    >
      <div
        class="w-full max-w-md bg-white rounded-2xl shadow-xl border border-slate-200 overflow-hidden"
      >
        <div
          class="p-4 border-b border-slate-200 flex items-center justify-between"
        >
          <h2 class="text-base font-semibold">Resetear contraseña</h2>
          <button
            class="px-3 py-1.5 rounded-xl border border-slate-300 hover:bg-slate-50"
            data-close="modalReset"
          >
            Cerrar
          </button>
        </div>

        <div class="p-4">
          <p class="text-slate-700">
            Vas a resetear la contraseña del usuario
            <span id="resetCorreo" class="font-semibold"></span>.
          </p>

          <div
            class="mt-3 text-sm text-slate-600 bg-slate-50 border border-slate-200 rounded-xl p-3 leading-relaxed"
          >
            <p class="font-semibold text-slate-800">¿Qué hace “Reset pass”?</p>
            <ul class="list-disc pl-5 mt-2 space-y-1">
              <li>Genera una <b>contraseña nueva aleatoria</b>.</li>
              <li>
                La guarda en la base de datos <b>hasheada con bcryptjs</b> (no
                se guarda en texto plano).
              </li>
              <li>
                La contraseña anterior <b>deja de funcionar</b> inmediatamente.
              </li>
              <li>
                Te mostrará la nueva contraseña <b>una sola vez</b> para que la
                compartas con el usuario de cocina.
              </li>
            </ul>
          </div>

          <div
            id="resetError"
            class="hidden mt-3 text-sm text-red-600 bg-red-50 border border-red-200 rounded-xl p-3"
          ></div>

          <div class="mt-4 flex items-center justify-end gap-2">
            <button
              type="button"
              class="px-3 py-2 rounded-xl border border-slate-300 hover:bg-slate-50"
              data-close="modalReset"
            >
              Cancelar
            </button>
            <button
              id="btnConfirmReset"
              class="px-3 py-2 rounded-xl bg-slate-900 text-white hover:bg-slate-800"
            >
              Sí, resetear
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="/admin/team.js" defer></script>
  </body>
</html>
